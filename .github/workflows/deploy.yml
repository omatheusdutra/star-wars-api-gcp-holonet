name: Deploy (GCP)

on:
  workflow_dispatch:
    inputs:
      run_gateway_update:
        description: 'Update API Gateway config'
        required: false
        default: 'true'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      REGION: ${{ secrets.GCP_REGION }}
      SERVICE_NAME: holonet-api
      GATEWAY_API_ID: holonet-api
      GATEWAY_CONFIG_ID: holonet-config
      GATEWAY_ID: holonet-gateway
      HAS_WIF: ${{ secrets.GCP_WORKLOAD_ID_PROVIDER != '' && secrets.GCP_SERVICE_ACCOUNT_EMAIL != '' }}
      HAS_JSON: ${{ secrets.GOOGLE_CREDENTIALS != '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auth (Workload Identity Federation)
        if: ${{ env.HAS_WIF == 'true' }}
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_ID_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Auth (Service Account JSON)
        if: ${{ env.HAS_JSON == 'true' && env.HAS_WIF != 'true' }}
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_CREDENTIALS }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy Cloud Run (private via IAM)
        run: |
          bash infra/gcloud/deploy_cloudrun.sh "$PROJECT_ID" "$REGION" "$SERVICE_NAME"

      - name: Grant API Gateway invoker on Cloud Run (IAM)
        run: |
          PROJECT_NUMBER="$(gcloud projects describe "$PROJECT_ID" --format='value(projectNumber)')"
          # Remove public invoker if present (no-op if already removed).
          gcloud run services remove-iam-policy-binding "$SERVICE_NAME" \
            --region "$REGION" \
            --member="allUsers" \
            --role="roles/run.invoker" || true

          # Allow API Gateway managed service account to invoke Cloud Run.
          gcloud run services add-iam-policy-binding "$SERVICE_NAME" \
            --region "$REGION" \
            --member="serviceAccount:service-${PROJECT_NUMBER}@gcp-sa-apigateway.iam.gserviceaccount.com" \
            --role="roles/run.invoker"

      - name: Update API Gateway
        if: ${{ inputs.run_gateway_update == 'true' }}
        run: |
          bash infra/gcloud/create_gateway.sh "$PROJECT_ID" "$REGION" "$SERVICE_NAME" "$GATEWAY_API_ID" "$GATEWAY_CONFIG_ID" "$GATEWAY_ID"

      - name: Smoke tests (Gateway public routes)
        run: |
          GATEWAY_HOST=$(gcloud api-gateway gateways describe "$GATEWAY_ID" --location "$REGION" --format='value(defaultHostname)')
          curl -fsS "https://$GATEWAY_HOST/health"
          curl -fsS "https://$GATEWAY_HOST/openapi.json" >/dev/null
