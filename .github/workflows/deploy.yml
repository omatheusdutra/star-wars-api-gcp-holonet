name: Deploy (GCP)

on:
  workflow_dispatch:
    inputs:
      run_gateway_update:
        description: 'Update API Gateway config'
        required: false
        default: 'true'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      REGION: ${{ secrets.GCP_REGION }}
      FUNCTION_NAME: holonet-api
      GATEWAY_API_ID: holonet-api
      GATEWAY_CONFIG_ID: holonet-config
      GATEWAY_ID: holonet-gateway
      HAS_WIF: ${{ secrets.GCP_WORKLOAD_ID_PROVIDER != '' && secrets.GCP_SERVICE_ACCOUNT_EMAIL != '' }}
      HAS_JSON: ${{ secrets.GOOGLE_CREDENTIALS != '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auth (Workload Identity Federation)
        if: ${{ env.HAS_WIF == 'true' }}
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_ID_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Auth (Service Account JSON)
        if: ${{ env.HAS_JSON == 'true' && env.HAS_WIF != 'true' }}
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_CREDENTIALS }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy Cloud Function (Gen2)
        run: |
          bash infra/gcloud/deploy.sh "$PROJECT_ID" "$REGION" "$FUNCTION_NAME"

      - name: Update API Gateway
        if: ${{ inputs.run_gateway_update == 'true' }}
        run: |
          bash infra/gcloud/create_gateway.sh "$PROJECT_ID" "$REGION" "$FUNCTION_NAME" "$GATEWAY_API_ID" "$GATEWAY_CONFIG_ID" "$GATEWAY_ID"

      - name: Smoke tests (Function URL)
        run: |
          FUNCTION_URL=$(gcloud functions describe "$FUNCTION_NAME" --gen2 --region "$REGION" --format='value(url)')
          curl -fsS "$FUNCTION_URL/v1/health"
          curl -fsS "$FUNCTION_URL/v1/meta"
